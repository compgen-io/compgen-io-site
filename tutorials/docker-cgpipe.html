<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Tutorial: Docker with cgpipe - compgen.io</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-83662616-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-83662616-1'); </script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Tutorial: Docker with cgpipe | compgen.io</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Tutorial: Docker with cgpipe" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Data wrangling tools for computational genomics" /> <meta property="og:description" content="Data wrangling tools for computational genomics" /> <link rel="canonical" href="https://compgen.io/tutorials/docker-cgpipe" /> <meta property="og:url" content="https://compgen.io/tutorials/docker-cgpipe" /> <meta property="og:site_name" content="compgen.io" /> <script type="application/ld+json"> {"@type":"WebPage","url":"https://compgen.io/tutorials/docker-cgpipe","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://compgen.io/assets/img/compgen.png"}},"headline":"Tutorial: Docker with cgpipe","description":"Data wrangling tools for computational genomics","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://compgen.io/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item "><a href="https://compgen.io/" class="navigation-list-link">Home</a></li><li class="navigation-list-item "><a href="https://compgen.io/projects" class="navigation-list-link">Projects</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://compgen.io/ngsutilsj" class="navigation-list-link">ngsutilsj</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/cgsplice.html" class="navigation-list-link">cgsplice</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/swalign.html" class="navigation-list-link">swalign</a> </li><li class="navigation-list-item nav_gap"><a href="https://compgen.io/cgpipe" class="navigation-list-link">cgpipe</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/sbs" class="navigation-list-link">sbs</a> </li><li class="navigation-list-item nav_gap"><a href="https://compgen.io/tabl" class="navigation-list-link">tabl</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/kdpeaks.html" class="navigation-list-link">kdpeaks</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/compgen-common.html" class="navigation-list-link">compgen-common</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/compgen-cmdline.html" class="navigation-list-link">compgen-cmdline</a> </li><li class="navigation-list-item nav_gap"><a href="https://compgen.io/projects/ngsutils" class="navigation-list-link">NGSUtils</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/tabutils.html" class="navigation-list-link">tabutils</a> </li><li class="navigation-list-item "><a href="https://compgen.io/projects/basespace-download.html" class="navigation-list-link">basespace-download</a> </li></ul></li><li class="navigation-list-item nav_gap "><a href="https://compgen.io/contact" class="navigation-list-link">Contact / Help</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4"> <!-- <a href="https://compgen.io/"><img src="assets/img/compgen-icon.png" style="float:left; width: 32px;"/> compgen.io</a><br/>data wrangling for <br/>computational genomics --> <a href="https://compgen.io/" class="footer_link"><img src="https://compgen.io//assets/img/compgen-slug.png"/></a> </p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="subtitle"> Data wrangling for computational genomics </div> <ul class="list-style-none text-small aux-nav"> <li class="d-inline-block my-0"><a href="//github.com/compgen-io">GitHub</a></li> </ul> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">Tutorials</a></li> <li class="breadcrumb-nav-list-item"><span>Tutorial: Docker with cgpipe</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <h1 class="no_toc" id="tutorial-docker-with-cgpipe"> <a href="#tutorial-docker-with-cgpipe" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Tutorial: Docker with cgpipe </h1> <h2 class="no_toc text-delta" id="overview"> <a href="#overview" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Overview </h2> <ol id="markdown-toc"> <li><a href="#heredocs" id="markdown-toc-heredocs">Heredocs</a></li> <li><a href="#docker" id="markdown-toc-docker">Docker</a> <ol> <li><a href="#job-integration" id="markdown-toc-job-integration">Job integration</a></li> <li><a href="#alternatives" id="markdown-toc-alternatives">Alternatives</a></li> </ol> </li> <li><a href="#meta-targets" id="markdown-toc-meta-targets">Meta-targets</a></li> <li><a href="#job-settings" id="markdown-toc-job-settings">Job settings</a></li> <li><a href="#putting-it-all-together" id="markdown-toc-putting-it-all-together">Putting it all together</a></li> </ol> <p><a href="/cgpipe">CGpipe</a> is a powerful tool for executing bioinformatics data analysis workflows. Much of its power derives from its inherent flexibility. In addition to supporting a variety of batch scheduling environments (SGE, SLURM, PBS), it can support different modes of executing jobs, such as in the context of a Docer container. The way we'll explore executing jobs within a container is to use the <a href="https://en.wikipedia.org/wiki/Here_document">HEREDOC pattern</a>.</p> <h2 id="heredocs"> <a href="#heredocs" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Heredocs </h2> <p>What are heredocs? Heredocs are a feature of shell scripts that let you send multiple lines of data as <em>stdin</em> to a program (an input-stream literal). One common way they are used is to write multiple lines to a file at a time.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt;HEREDOC &gt; output.txt
line 1
line 2
etc...
HEREDOC
</code></pre></div></div> <p>You don't need to use the delimiter <code class="language-plaintext highlighter-rouge">HEREDOC</code>, it could be any string. Another commonly used string is <code class="language-plaintext highlighter-rouge">EOF</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &lt;&lt;EOF &gt; output.txt
etc...
EOF
</code></pre></div></div> <p>We are going to use this to have CGPipe wrap a job script and send that as <em>stdin</em> to <code class="language-plaintext highlighter-rouge">bash</code> running in a container.</p> <h2 id="docker"> <a href="#docker" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Docker </h2> <p>We'll assume you're already familiar with <a href="http://www.docker.com">Docker</a>, but briefly Docker a platform for running programs within a container. The container lets you build and ship programs with any needed dependencies intact. This results in a consistent execution environment for data analysis pipelines.</p> <p>It is out of the scope of this document to go into all of the ways that Docker can be started (or how to create a container image). However, if your job can be started as a shell script, you can use this method to run your job in a container. We will use <code class="language-plaintext highlighter-rouge">docker run</code> to start our script.</p> <h3 id="job-integration"> <a href="#job-integration" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Job integration </h3> <p>In order to use the Docker container, we will mount the current working directory as <code class="language-plaintext highlighter-rouge">/data</code> in the Docker container. This will be the working directory for the job. We will then start the container and execute the given job snippet in the context of the container by using <code class="language-plaintext highlighter-rouge">/bin/bash</code> as our Docker entrypoint.</p> <p>Note: This is only one way to do this and may not be the best solution for your environment. But this should be a good starting point to adapt to your system.</p> <h3 id="alternatives"> <a href="#alternatives" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Alternatives </h3> <p>Here are some alternatives to Docker containers for software versioning:</p> <ul> <li><a href="http://modules.sourceforge.net">Environment modules</a> - The original method for managing program versions. This (or a similar tool) is installed on most HPC clusters.</li> <li><a href="http://singularity.lbl.gov/">Singularity containers</a> - Docker-alternative container tool from Berkeley Lab that doesn't require special permissions and is compatible with existing multi-user HPC systems. The technique used here for Docker should also be applicable to Singularity containers.</li> </ul> <h2 id="meta-targets"> <a href="#meta-targets" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Meta-targets </h2> <p>The feature of CGPipe that will help us get our jobs running in a container are the setup/teardown/pre/post meta-targets.</p> <p>These are named <code class="language-plaintext highlighter-rouge">__setup__</code>, <code class="language-plaintext highlighter-rouge">__teardown__</code>, <code class="language-plaintext highlighter-rouge">__pre__</code>, and <code class="language-plaintext highlighter-rouge">__post__</code> and are defined like any other job definition. However, <strong>setup</strong> and <strong>teardown</strong> are executed at pipeline run-time (not submitted to a scheduler) to do things like make a child directory or remove a temporary file. <strong>Setup</strong> is run before any other jobs are submitted to the scheduler and <strong>teardown</strong> is executed before CGPipe returns. However, <strong>pre</strong> and <strong>post</strong> are job meta-targets that are included in the main job snippet. Crucially, they are <em>not</em> job dependencies, they are included in the body of the job script itself.</p> <p>How can this be helpful? One example is to track the time required for a job to start/finish. Let's say you had the following job definition:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>output.txt: input.txt
    ./myprog input.txt &gt; output.txt
</code></pre></div></div> <p>This would result in the following job script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
./myprog input.txt &gt; output.txt
</code></pre></div></div> <p>As an example, this is a pretty simple pipeline that has only one task. If you wanted to write the start / finish times to stdout for this job, you could use the <strong>pre</strong> and <strong>post</strong> meta-targets like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>__pre__:
  echo "Start: \\$(date)"

__post__:
  echo "Done: \\$(date)"

output.txt: input.txt
    ./myprog input.txt &gt; output.txt
</code></pre></div></div> <p>This will result in a job script that looks something like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
echo "Start: $(date)"
./myprog input.txt &gt; output.txt
echo "Done: $(date)"
</code></pre></div></div> <p>If you have multiple tasks, <strong>pre</strong> and <strong>post</strong> are applied to each job. This makes these meta targets a powerful method for altering or monitoring the execution of each task in a pipeline. Some other examples where the <strong>pre</strong> and <strong>post</strong> meta-targets could come in handy tracking job start/finish in an external monitoring program, downloading inputs from cloud storage (e.g. S3), uploading outputs to cloud storage, changing file permissions, etc…</p> <p>Note the escaped <code class="language-plaintext highlighter-rouge">\\$(date)</code> above – if this wasn't escaped CGPipe would shell out to get the date at run-time. This would then show the date/time that the script was run. An alternative would be to avoid the shell escape and do something like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>__pre__:
  echo -n "Start: "
  date
</code></pre></div></div> <h2 id="job-settings"> <a href="#job-settings" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Job settings </h2> <p>CGPipe job snippets are nothing more than shell (bash) scripts, which in combination with the <strong>pre</strong> and <strong>post</strong> meta-targets gives a pipeline author a lot of flexibility. It also means that you can adapt the pipeline to work with your system, not adapt your system to the pipeline.</p> <p>Because not all jobs will require a Docker container to execute, it is appropriate to configure the container settings on a job-by-job basis. Like all job settings, it is possible to set these on a per-job, per-pipeline, or per-system basis. Any cgpipe variable starting with <code class="language-plaintext highlighter-rouge">job.</code> (including user-defined ones) is available within the job snippet context (including <strong>pre</strong> and <strong>post</strong>), so we will use that to set a few Docker-specific variables. Specifically, we will use <code class="language-plaintext highlighter-rouge">job.docker.container</code>. <code class="language-plaintext highlighter-rouge">job.docker.container</code> will be set to the container image name to use for this job.</p> <p>You can also use a similar strategy to set things like volumes or other resource requirements for the container, but we'll keep things simple for now.</p> <h2 id="putting-it-all-together"> <a href="#putting-it-all-together" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Putting it all together </h2> <p>For an example, lets assume you have a BAM file and you'd like to calculate some alignment QC statistics. One way to do this would be to use <a href="/ngsutilsj">ngsutilsj</a> and run the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngsutilsj bam-stats input.bam &gt; output.stats.txt
</code></pre></div></div> <p>We may not have <code class="language-plaintext highlighter-rouge">ngsutilsj</code> installed on our system, but it is available in the <code class="language-plaintext highlighter-rouge">asclab/spcg-working</code> Docker container.</p> <p>To setup the Docker container, we'll use the <em>pre</em> and <em>post</em> meta-targets to wrap the entire job snippet in a HEREDOC. That will then send the script to a the container's entrypoint (<code class="language-plaintext highlighter-rouge">/bin/bash</code>) to execute in the context of the container.</p> <p>Here is what our trival example looks like as a cgpipe script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env cgpipe
output.stats.txt: input.bam
    ngsutilsj bam-stats input.bam &gt; output.stats.txt
</code></pre></div></div> <p>Now, we can add the <code class="language-plaintext highlighter-rouge">__pre__</code> and <code class="language-plaintext highlighter-rouge">__post__</code> to wrap the snippet. Note: this assumes the program <code class="language-plaintext highlighter-rouge">realpath</code> is installed. <code class="language-plaintext highlighter-rouge">realpath</code> is used to get the absolute path for the current directory. Absolute paths are required by Docker to bind local directories as volumes in the container (you can also get this with a Perl or Python one-liner).</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/env cgpipe
__pre__:
    &lt;% if job.docker.container %&gt;
    docker run --rm -i \
      -v $(realpath .):/data \
      -w /data
      ${job.docker.container} /bin/bash &lt;&lt;HEREDOC
    &lt;% endif %&gt;

__post__:
    &lt;% if job.docker.container %&gt;
    HEREDOC
    &lt;% endif %&gt;

output.stats.txt: input.bam
    &lt;%
      job.docker.container="asclab/spcg-working"
    %&gt;
    ngsutilsj bam-stats input.bam &gt; output.stats.txt
</code></pre></div></div> <p>This results in the following job script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
docker run --rm -i \
  -v /my/path:/data \
  -w /data
  asclab/spcg-working /bin/bash &lt;&lt;HEREDOC
ngsutilsj bam-stats input.bam &gt; output.stats.txt
HEREDOC
</code></pre></div></div> <p>One thing to look out for is the whitespace surrounding the <code class="language-plaintext highlighter-rouge">HEREDOC</code> in <code class="language-plaintext highlighter-rouge">__post__</code>. This needs to end up as the first thing on a line without any preceeding whitespace. If you use consistent indentation, this normally isn't a problem, but it's something to look out for.</p> </div> </div> </div> </div> </body> </html>
