<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83662616-1', 'auto');
  ga('send', 'pageview');

</script>


    <base href="https://compgen.io/">
    <title>compgen.io - docker containers with cgpipe</title>
    <link rel="canonical" href="https://compgen.io/tutorials/cgpipe-docker/">

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,100' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" crossorigin="anonymous">





<link rel="stylesheet/less" type="text/css" href="/css/style.less" />

<script src="/js/less.min.js" type="text/javascript"></script>
<link rel="shortcut icon" href="/favicon.ico" />

</head>
<body lang="en">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<div class="header_wrap">
<div class="header">
  <div class="logo"><a href="/"><img src="/img/compgen-logo.png" alt="compgen.io"/></a></div>
  <div class="slogan">data wrangling for<br/>computational genomics</div>
  <ul class="links">
      <li class="links dropdown">
          <a href="/projects" style="padding-right: 0;"><i class="fa fa-cogs"></i>&nbsp;Projects</a>
          <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="padding-left: 2px;" id="dropdownMenu1">
            <span class="fa fa-sort-down"></span>
            <span class="sr-only">Toggle Projects Dropdown</span>
          </a>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
              <li class="dropdown-header">NGS data analysis</li>
            <li><a href="/ngsutilsj">ngsutilsj (newer)</a></li>
            <li><a href="/ngsutils">NGSUtils (older)</a></li>
            <li><a href="/cgsplice">cgsplice</a></li>
            <li><a href="/sqz">SQZ</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Data analysis pipelines</li>
            <li><a href="/cgpipe">cgpipe</a></li>
            <li><a href="/sbs">SBS</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Misc. tools</li>
            <li><a href="/basespace-download">Basespace-download</a></li>
            
            <li><a href="/swalign">swalign</a></li>
            <li><a href="/tabutils">tabutils</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Programming libraries</li>
            <li><a href="/compgen-common">compgen-common</a></li>
            <li><a href="/compgen-cmdline">compgen-cmdline</a></li>
          </ul>
      </li>
      <li class="links"><a href="/tutorials"><i class="fa fa-book"></i>&nbsp;Tutorials</a></li>

      <li class="links"><a href="/citations"><i class="fa fa-external-link-squaref"></i> Citations</a></li>
      <li class="links"><a href="/contact"><i class="fa fa-question-circle"></i>&nbsp;Contact</a></li>


  </ul>
  <div class="clearing">&nbsp;</div>
</div>
</div>

<div class="main_wrap">
  <section id="main">
  <div class="breadcrumbs">
      <a href="/tutorials">Back to tutorials...</a>
  </div>
    <h1 id="title">Docker containers with CGPipe</h1>
    <div>
          <article id="content" class="tutorial">
             

<p>CGPipe is a powerful tool for executeing bioinformatics data analysis workflows. Much
of its power derives from its inherent flexibility. In addition to supporting a variety of batch
scheduling environments (SGE, SLURM, PBS), it can support different modes of
executing jobs, such as in the context of a Docer container. The way we&rsquo;ll explore executing
jobs within a container is to use the <a href="https://en.wikipedia.org/wiki/Here_document">HEREDOC pattern</a>.</p>

<h2 id="heredocs">Heredocs</h2>

<p>What are heredocs? Heredocs are a feature of shell scripts that let you send multiple lines of
data as <em>stdin</em> to a program (an input-stream literal). One common way they are used is to write
multiple lines to a file at a time.</p>

<pre><code>cat &lt;&lt;HEREDOC &gt; output.txt
line 1
line 2
etc...
HEREDOC
</code></pre>

<p>You don&rsquo;t need to use the delimiter <code>HEREDOC</code>, it could be any string. Another commonly used string is <code>EOF</code>.</p>

<pre><code>cat &lt;&lt;EOF &gt; output.txt
etc...
EOF
</code></pre>

<p>We are going to use this to have CGPipe wrap a job script and send that as <em>stdin</em> to <code>bash</code> running in a container.</p>

<h2 id="docker">Docker</h2>

<p>We&rsquo;ll assume you&rsquo;re already familiar with <a href="http://www.docker.com">Docker</a>, but briefly Docker
a platform for running programs within a container. The container lets you build and ship programs with any needed
dependencies intact. This results in a consistent execution environment for data analysis pipelines.</p>

<p>It is out of the scope of this document to go into all of the ways that Docker can be started (or how to
create a container image). However, if your job can be started as a shell script, you can use this method
to run your job in a container. We will use <code>docker run</code> to start our script.</p>

<h3 id="job-integration">Job integration</h3>

<p>In order to use the Docker container, we will mount the current working directory as <code>/data</code>
in the Docker container. This will be the working directory for the job. We will then start the
container and execute the given job snippet in the context of the container by using <code>/bin/bash</code> as our
Docker entrypoint.</p>

<p>Note: This is only one way to do this and may not be the best solution for your environment. But this
should be a good starting point to adapt to your system.</p>

<h3 id="alternatives">Alternatives</h3>

<p>Here are some alternatives to Docker containers for software versioning:</p>

<ul>
<li><a href="http://modules.sourceforge.net">Environment modules</a> - The original method for managing program versions. This (or a similar tool) is installed on most HPC clusters.</li>
<li><a href="http://singularity.lbl.gov/">Singularity containers</a> - Docker-alternative container tool from Berkeley Lab that doesn&rsquo;t require special permissions and is compatible with existing multi-user HPC systems. The technique used here for Docker should also be applicable to Singularity containers.</li>
</ul>

<h2 id="meta-targets">Meta-targets</h2>

<p>The feature of CGPipe that will help us get our jobs running in a container are the setup/teardown/pre/post meta-targets.</p>

<p>These are named <code>__setup__</code>, <code>__teardown__</code>, <code>__pre__</code>, and <code>__post__</code> and are defined like any other job definition.
However, <strong>setup</strong> and <strong>teardown</strong> are executed at pipeline run-time (not submitted to a scheduler) to do things like
make a child directory or remove a temporary file. <strong>Setup</strong> is run before any other jobs are submitted to the
scheduler and <strong>teardown</strong> is executed before CGPipe returns. However, <strong>pre</strong> and <strong>post</strong> are job
meta-targets that are included in the main job snippet. Crucially, they are <em>not</em> job dependencies, they are included
in the body of the job script itself.</p>

<p>How can this be helpful? One example is to track the time required for a job to start/finish.  Let&rsquo;s say you had the
following job definition:</p>

<pre><code>output.txt: input.txt
    ./myprog input.txt &gt; output.txt
</code></pre>

<p>This would result in the following job script:</p>

<pre><code>#!/bin/bash
./myprog input.txt &gt; output.txt
</code></pre>

<p>As an example, this is a pretty simple pipeline that has only one task. If you wanted to write the start / finish
times to stdout for this job, you could use the <strong>pre</strong> and <strong>post</strong> meta-targets like this:</p>

<pre><code>__pre__:
  echo &quot;Start: \\$(date)&quot;

__post__:
  echo &quot;Done: \\$(date)&quot;

output.txt: input.txt
    ./myprog input.txt &gt; output.txt
</code></pre>

<p>This will result in a job script that looks something like this:</p>

<pre><code>#!/bin/bash
echo &quot;Start: $(date)&quot;
./myprog input.txt &gt; output.txt
echo &quot;Done: $(date)&quot;
</code></pre>

<p>If you have multiple tasks, <strong>pre</strong> and <strong>post</strong> are applied to each job. This makes these meta
targets a powerful method for altering or monitoring the execution of each task in a pipeline. Some other examples where
the <strong>pre</strong> and <strong>post</strong> meta-targets could come in handy tracking job start/finish in an external
monitoring program, downloading inputs from cloud storage (e.g. S3), uploading outputs to cloud storage, changing file
permissions, etc&hellip;</p>

<p>Note the escaped <code>\\$(date)</code> above &ndash; if this wasn&rsquo;t escaped CGPipe would shell out to get the date at run-time. This would
then show the date/time that the script was run. An alternative would be to avoid the shell escape and do something
like this:</p>

<pre><code>__pre__:
  echo -n &quot;Start: &quot;
  date
</code></pre>

<h2 id="job-settings">Job settings</h2>

<p>CGPipe job snippets are nothing more than shell (bash) scripts, which in combination with the <strong>pre</strong> and <strong>post</strong> meta-targets
gives a pipeline author a lot of flexibility. It also means that you can adapt the pipeline to work with your system, not
adapt your system to the pipeline.</p>

<p>Because not all jobs will require a Docker container to execute, it is appropriate to configure the container
settings on a job-by-job basis. Like all job settings, it is possible to set these on a per-job, per-pipeline,
or per-system basis. Any cgpipe variable starting with <code>job.</code> (including user-defined ones) is available within
the job snippet context (including <strong>pre</strong> and <strong>post</strong>), so we will use that to set a few
Docker-specific variables. Specifically, we will use <code>job.docker.container</code>. <code>job.docker.container</code>
will be set to the container image name to use for this job.</p>

<p>You can also use a similar strategy to set things like volumes or other resource requirements for the container,
but we&rsquo;ll keep things simple for now.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>For an example, lets assume you have a BAM file and you&rsquo;d like to calculate some alignment QC statistics.
One way to do this would be to use <a href="/ngsutilsj">ngsutilsj</a> and run the following:</p>

<pre><code>ngsutilsj bam-stats input.bam &gt; output.stats.txt
</code></pre>

<p>We may not have <code>ngsutilsj</code> installed on our system, but it is available in the <code>asclab/spcg-working</code> Docker container.</p>

<p>To setup the Docker container, we&rsquo;ll use the <em>pre</em> and <em>post</em>
meta-targets to wrap the entire job snippet in a HEREDOC. That will then send the script to a the container&rsquo;s
entrypoint (<code>/bin/bash</code>) to execute in the context of the container.</p>

<p>Here is what our trival example looks like as a cgpipe script:</p>

<pre><code>#!/usr/bin/env cgpipe
output.stats.txt: input.bam
    ngsutilsj bam-stats input.bam &gt; output.stats.txt
</code></pre>

<p>Now, we can add the <code>__pre__</code> and <code>__post__</code> to wrap the snippet. Note: this assumes the program <code>realpath</code>
is installed. <code>realpath</code> is used to get the absolute path for the current directory. Absolute paths are
required by Docker to bind local directories as volumes in the container (you can also get this with a
Perl or Python one-liner).</p>

<pre><code>#!/usr/bin/env cgpipe
__pre__:
    &lt;% if job.docker.container %&gt;
    docker run --rm -i \
      -v $(realpath .):/data \
      -w /data
      ${job.docker.container} /bin/bash &lt;&lt;HEREDOC
    &lt;% endif %&gt;

__post__:
    &lt;% if job.docker.container %&gt;
    HEREDOC
    &lt;% endif %&gt;

output.stats.txt: input.bam
    &lt;%
      job.docker.container=&quot;asclab/spcg-working&quot;
    %&gt;
    ngsutilsj bam-stats input.bam &gt; output.stats.txt
</code></pre>

<p>This results in the following job script:</p>

<pre><code>#!/bin/bash
docker run --rm -i \
  -v /my/path:/data \
  -w /data
  asclab/spcg-working /bin/bash &lt;&lt;HEREDOC
ngsutilsj bam-stats input.bam &gt; output.stats.txt
HEREDOC
</code></pre>

<p>One thing to look out for is the whitespace surrounding the <code>HEREDOC</code> in <code>__post__</code>. This needs to end up
as the first thing on a line without any preceeding whitespace. If you use consistent indentation, this normally
isn&rsquo;t a problem, but it&rsquo;s something to look out for.</p>

          </article>
    </div>
  </section>
</div>

<div class="footer_wrap">
<div class="footer">
<div>

<b>compgen.io</b>&nbsp;&nbsp;&middot;&nbsp;&nbsp; Copyright &copy;2016-2018
<br/><br/>
<a href="http://github.com/compgen-io">http://github.com/compgen-io</a><br/>
<a href="http://github.com/mbreese">http://github.com/mbreese</a><br/>
<a href="http://github.com/ngsutils">http://github.com/ngsutils</a><br/>
</div>
</div>
</div>

</body>
